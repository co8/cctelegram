# CC Telegram Bridge Event System Documentation

## Overview

The CC Telegram Bridge features a comprehensive event system designed to handle all typical Claude Code operations and system activities. The system has been expanded from 3 basic event types to 44+ comprehensive event types, providing complete coverage of development workflows, monitoring, and user interactions.

## Event System Architecture

### Core Components

- **Event Types**: 44+ specialized event types covering all aspects of development workflows
- **EventData**: Comprehensive data structure with 50+ optional fields
- **Builder Pattern**: 15+ specialized builder methods for common scenarios
- **Validation System**: Event-type specific validation with severity and priority levels
- **Utility Methods**: Rich set of methods for event analysis and categorization

### Event Categories

#### 1. Task Management Events (5 types)
- `TaskCompletion` - Task successfully completed
- `TaskStarted` - Task initiated
- `TaskFailed` - Task failed with error details
- `TaskProgress` - Task progress updates
- `TaskCancelled` - Task cancelled by user or system

#### 2. Code Operation Events (6 types)
- `CodeGeneration` - Code generated by Claude Code
- `CodeAnalysis` - Code analysis completed
- `CodeRefactoring` - Code refactoring performed
- `CodeReview` - Code review completed
- `CodeTesting` - Code testing executed
- `CodeDeployment` - Code deployed to target environment

#### 3. File System Events (5 types)
- `FileCreated` - New file created
- `FileModified` - Existing file modified
- `FileDeleted` - File removed
- `DirectoryCreated` - New directory created
- `DirectoryDeleted` - Directory removed

#### 4. Build & Development Events (8 types)
- `BuildStarted` - Build process initiated
- `BuildCompleted` - Build process completed successfully
- `BuildFailed` - Build process failed
- `TestSuiteRun` - Test suite execution
- `TestPassed` - Individual test passed
- `TestFailed` - Individual test failed
- `LintCheck` - Code linting performed
- `TypeCheck` - Type checking performed

#### 5. Git & Version Control Events (7 types)
- `GitCommit` - Git commit created
- `GitPush` - Code pushed to remote repository
- `GitMerge` - Branch merge completed
- `GitBranch` - New branch created or switched
- `GitTag` - Git tag created
- `PullRequestCreated` - Pull request opened
- `PullRequestMerged` - Pull request merged

#### 6. System & Monitoring Events (5 types)
- `SystemHealth` - System health check results
- `PerformanceAlert` - Performance threshold exceeded
- `SecurityAlert` - Security issue detected
- `ErrorOccurred` - System error encountered
- `ResourceUsage` - Resource usage metrics

#### 7. User Interaction Events (3 types)
- `ApprovalRequest` - User approval required
- `UserResponse` - User response received
- `CommandExecuted` - User command executed

#### 8. Notification Events (4 types)
- `ProgressUpdate` - General progress update
- `StatusChange` - Status change notification
- `AlertNotification` - Alert notification
- `InfoNotification` - Informational notification

#### 9. Integration Events (3 types)
- `ApiCall` - External API call made
- `WebhookReceived` - Webhook received
- `ServiceIntegration` - Service integration event

#### 10. Custom Events (1 type)
- `CustomEvent` - User-defined custom events

## EventData Structure

The `EventData` structure contains 50+ optional fields organized into logical groups:

### Core Fields
- `status: Option<String>` - Event status (completed, failed, etc.)
- `results: Option<String>` - Event results or output
- `exit_code: Option<i32>` - Process exit code
- `success: Option<bool>` - Success/failure flag

### File Information
- `file_path: Option<String>` - Primary file path
- `files_affected: Option<Vec<String>>` - List of affected files
- `directory: Option<String>` - Directory path
- `line_number: Option<u32>` - Line number in file

### Code Information
- `language: Option<String>` - Programming language
- `function_name: Option<String>` - Function name
- `class_name: Option<String>` - Class name
- `module_name: Option<String>` - Module name
- `code_snippet: Option<String>` - Code snippet

### Git Information
- `commit_hash: Option<String>` - Git commit hash
- `branch_name: Option<String>` - Git branch name
- `author: Option<String>` - Commit author
- `commit_message: Option<String>` - Commit message
- `files_changed: Option<Vec<String>>` - Files changed in commit

### Build and Test Information
- `build_target: Option<String>` - Build target
- `test_count: Option<u32>` - Total test count
- `tests_passed: Option<u32>` - Passed test count
- `tests_failed: Option<u32>` - Failed test count
- `coverage_percentage: Option<f32>` - Test coverage percentage
- `duration_ms: Option<u64>` - Duration in milliseconds

### Performance and System Information
- `memory_usage_mb: Option<f64>` - Memory usage in MB
- `cpu_usage_percent: Option<f32>` - CPU usage percentage
- `disk_usage_mb: Option<f64>` - Disk usage in MB
- `network_bytes: Option<u64>` - Network bytes transferred

### Error Information
- `error_message: Option<String>` - Error message
- `error_code: Option<String>` - Error code
- `stack_trace: Option<String>` - Stack trace
- `severity: Option<String>` - Severity level (low, medium, high, critical)

### User Interaction
- `approval_prompt: Option<String>` - Approval prompt text
- `options: Option<Vec<String>>` - Available options
- `user_id: Option<String>` - User identifier
- `command: Option<String>` - Executed command
- `arguments: Option<Vec<String>>` - Command arguments

### Notification Information
- `priority: Option<String>` - Priority level (low, normal, high, urgent)
- `category: Option<String>` - Event category
- `tags: Option<Vec<String>>` - Event tags
- `url: Option<String>` - Related URL
- `actions: Option<Vec<ActionButton>>` - Action buttons

### Integration Information
- `service_name: Option<String>` - Service name
- `endpoint: Option<String>` - API endpoint
- `request_id: Option<String>` - Request identifier
- `response_code: Option<u16>` - HTTP response code

### Custom and Extended Data
- `metadata: Option<HashMap<String, serde_json::Value>>` - Custom metadata

## Builder Pattern Usage

### Basic Event Creation

```rust
use cc_telegram_bridge::events::types::{Event, EventType};

// Create a basic event
let event = Event::new(
    EventType::TaskCompletion,
    "claude-code",
    "task-001",
    "Code Generation Complete",
    "Successfully generated user authentication module"
);
```

### Specialized Builder Methods

#### Task Completion
```rust
let event = Event::task_completed(
    "claude-code",
    "task-001", 
    "Code Generation Complete",
    Some("Generated 5 files, 250 lines of code".to_string())
);
```

#### Code Generation
```rust
let event = Event::code_generated(
    "claude-code",
    "gen-001",
    "src/auth.rs".to_string(),
    "rust".to_string()
);
```

#### Build Completion
```rust
let event = Event::build_completed(
    "build-system",
    "build-001",
    "release".to_string(),
    120, // passed tests
    0,   // failed tests
    95.5 // coverage percentage
);
```

#### Git Commit
```rust
let event = Event::git_commit(
    "git",
    "commit-001",
    "abc123def456".to_string(),
    "Add user authentication module".to_string(),
    "John Developer".to_string(),
    vec!["src/auth.rs".to_string(), "tests/auth_test.rs".to_string()]
);
```

#### Performance Alert
```rust
let event = Event::performance_alert(
    "monitoring",
    "alert-001",
    "Memory Usage".to_string(),
    85.5, // current value
    80.0  // threshold
);
```

#### Approval Request
```rust
let event = Event::approval_request(
    "claude-code",
    "approval-001",
    "Deploy to Production",
    "Ready to deploy version 1.8.5 to production?".to_string(),
    vec!["Deploy".to_string(), "Cancel".to_string()]
);
```

#### Error Occurred
```rust
let event = Event::error_occurred(
    "compiler",
    "error-001",
    "Compilation Error".to_string(),
    "E0308: mismatched types".to_string(),
    "high".to_string()
);
```

#### File Modified
```rust
let event = Event::file_modified(
    "file-watcher",
    "mod-001",
    "src/main.rs".to_string(),
    "rust".to_string()
);
```

## Comprehensive Validation and Integrity System

The event system features an enterprise-grade validation and integrity system designed to achieve **zero message loss** through comprehensive data validation, event deduplication, and integrity checking.

### ValidationError System

The system includes a comprehensive `ValidationError` enum with **14 specific error types** and user-friendly messages:

```rust
pub enum ValidationError {
    EmptyField { field: String },
    InvalidLength { field: String, current: usize, min: Option<usize>, max: Option<usize> },
    InvalidFormat { field: String, expected_format: String },
    InvalidTimestamp { reason: String },
    InvalidUuid { field: String },
    MissingRequiredField { field: String, context: String },
    InvalidValue { field: String, value: String, allowed_values: Vec<String> },
    InvalidDuration { reason: String },
    InvalidProgressData { reason: String },
    InvalidApprovalData { reason: String },
    DuplicateEvent { event_id: String, original_timestamp: DateTime<Utc> },
    InconsistentEventData { reason: String },
    UnknownEventType { event_type: String },
    MissingEventData { required_data: String },
}
```

### Field Constraint Validation

**Title Validation**: 1-200 characters with non-empty requirement
**Description Validation**: 1-2000 characters for comprehensive details
**UUID Format Validation**: Proper UUID v4 format using regex patterns
**Timestamp Validation**: Reasonable time bounds (not too far in past/future)
**Duration Validation**: Sensible duration limits (max 24 hours)

### Business Logic Validation

**Event Type-Specific Rules**:
- **ApprovalRequest**: Must have approval_prompt and valid options array
- **TaskCompletion**: Must include status and results for completed tasks
- **PerformanceAlert**: Must include current value, threshold, and severity
- **ProgressUpdate**: Must include valid percentage or progress metadata
- **GitCommit**: Must include commit_hash, message, and author information
- **BuildCompletion**: Must include test counts and coverage percentage
- **ErrorOccurred**: Must include error_message and appropriate severity

### Event Deduplication System

Comprehensive deduplication prevents message loss through duplicate detection:

**Primary Deduplication**: Exact `event_id` matching for duplicate prevention
**Secondary Deduplication**: Content-based matching within configurable time window (default 5 seconds)
**Configurable Time Window**: Adjustable duplicate detection timeframe
**Comprehensive Logging**: Detailed duplicate detection logging for monitoring

```rust
// Deduplication example
let existing_events = vec![previous_event];
let errors = event.validate_with_deduplication(&existing_events);
if errors.iter().any(|e| matches!(e, ValidationError::DuplicateEvent { .. })) {
    println!("Duplicate event detected and prevented!");
}
```

### Severity Level Validation
Valid severity levels: `low`, `medium`, `high`, `critical`

### Priority Level Validation
Valid priority levels: `low`, `normal`, `high`, `urgent`

### Comprehensive Validation Usage
```rust
let mut event = Event::new(/*...*/);
event.data.severity = Some("high".to_string());

// Field constraint validation
let constraint_errors = event.validate_field_constraints();

// Business logic validation
let logic_errors = event.validate_business_logic();

// Deduplication validation
let dedup_errors = event.validate_with_deduplication(&existing_events);

// Comprehensive validation
match event.validate() {
    Ok(()) => println!("Event passed all validation checks"),
    Err(errors) => {
        for error in errors {
            println!("Validation error: {}", error.user_friendly_message());
        }
    },
}
```

## Utility Methods

### Event Analysis
```rust
let event = Event::performance_alert(/*...*/);

// Get event priority and severity
println!("Priority: {}", event.get_priority());
println!("Severity: {}", event.get_severity());

// Check if event is critical
if event.is_critical() {
    println!("This is a critical event!");
}

// Check if user interaction is required
if event.requires_user_interaction() {
    println!("User response needed");
}

// Get event category and summary
println!("Category: {}", event.get_category());
println!("Summary: {}", event.get_summary());
```

### Serialization
```rust
// Convert to JSON
let json_string = event.to_json().unwrap();

// Create from JSON
let event = Event::from_json(&json_string).unwrap();
```

### EventType Utilities
```rust
// Get all available event types
let all_types = EventType::all();

// Get display name
let name = EventType::CodeGeneration.display_name(); // "Code Generated"
```

## Telegram Integration

### Professional Message Design

The system features modern, professional message formatting with:

- **Bold Headers**: First line is bold using markdown `*text*` formatting
- **Clean Timestamps**: Concise format like `2/Aug/25 23:42` instead of verbose timestamps
- **Consistent Layout**: Structured three-line format for all message types
- **Visual Hierarchy**: Clear emoji-based categorization and visual separators

#### Message Format Structure
```
*{emoji} {Event Name} {Title}*
⏰ {timestamp}
📝 {description/details}
```

#### Example Message Formats

**Task Completion:**
```
*✅ Task Completed Deploy Authentication*
⏰ 2/Aug/25 23:42
📝 Authentication module deployed successfully with 100% test coverage
```

**Approval Request:**
```
*🔐 System Update Request*
⏰ 2/Aug/25 23:45
📝 Approval Required System Update Request

Please approve the system maintenance window scheduled for tonight.
```

**Progress Update:**
```
*📊 Progress Update Data Migration Progress*
⏰ 2/Aug/25 23:50
📝 Migration is 75% complete. Processing user data...
```

**Information Notification:**
```
*ℹ️ Information Final Format Demo*
⏰ 2/Aug/25 23:55
📝 This demonstrates the new concise message format with bold headers and clean timestamps.
```

### Event Type Icons

The system provides specialized emojis for each event type:

- **Task Events**: ✅ 🚀 ❌ 📊 🚫
- **Code Events**: 🔨 🔍 🔧 👁️ 🧪
- **File Events**: 📄 📝 🗑️ 📁
- **Build Events**: 🔨 ✅ ❌ 🧪 📏
- **Git Events**: 📝 ⬆️ 🔀 🌿 🏷️
- **System Events**: 💚 ⚡ 🔒 ❌ 📊
- **User Events**: 💬 ⚡
- **Notification Events**: 🔄 🚨 ℹ️
- **Integration Events**: 🌐 📡 🔗

### Action Buttons

Events can include interactive buttons for user actions:

```rust
let action = ActionButton::new(
    "approve".to_string(),
    "✅ Approve".to_string()
);
```

## Configuration

### Performance Settings
```toml
[performance]
memory_threshold_mb = 100
cpu_threshold_percent = 80.0
event_processing_threshold_ms = 1000
telegram_response_threshold_ms = 5000
metrics_collection_interval_seconds = 30
enable_detailed_logging = false
```

### Monitoring Settings
```toml
[monitoring]
health_check_port = 8080
enable_metrics_server = true
metrics_endpoint = "/metrics"
health_endpoint = "/health"
```

## JSON Serialization and Performance Optimization

The event system features advanced JSON serialization with significant performance improvements:

### Serialization Improvements

**86.3% Payload Size Reduction**: Achieved through intelligent null field omission and optimized JSON structure
**Snake_case Field Naming**: Consistent JSON field naming across all structures
**Custom Deserializers**: Forward compatibility through Unknown variant fallbacks
**Performance Benchmarks**: Average 72.82µs serialization, 60.549µs deserialization

### Forward Compatibility System

```rust
// Custom deserializer with fallback handling
impl<'de> Deserialize<'de> for EventType {
    fn deserialize<D>(deserializer: D) -> Result<EventType, D::Error>
    where D: Deserializer<'de> {
        let s = String::deserialize(deserializer)?;
        match s.as_str() {
            "task_completion" => Ok(EventType::TaskCompletion),
            // ... comprehensive mapping for all event types
            _ => {
                tracing::warn!("Unknown event type '{}', using Unknown variant", s);
                Ok(EventType::Unknown)
            }
        }
    }
}
```

### Payload Optimization Features

**Null Field Omission**: `#[serde(skip_serializing_if = "Option::is_none")]` for all optional fields
**Efficient Serialization**: Optimized JSON structure reduces bandwidth usage
**Round-trip Validation**: Comprehensive serialization/deserialization testing
**Backward Compatibility**: Maintains compatibility with existing event structures

## Comprehensive Testing Framework

The event system includes extensive test coverage with **61 passing tests** (+60% increase):

### Unit Tests (55 tests)
- Event creation and builder pattern tests
- Comprehensive validation system tests (6 new test functions)
- JSON serialization and performance optimization tests
- Category and utility method tests
- Action button and response event tests
- Deduplication logic and integrity testing
- Forward compatibility and error handling tests

### Integration Tests (6 tests)  
- End-to-end event processing workflow tests
- File storage operations and persistence
- Configuration loading and validation
- Telegram bot user validation and security
- Security manager and rate limiting functionality
- Message formatting and delivery testing

### New Test Categories (Task 2.4)
- `test_validation_error_messages` - Error message formatting and severity levels
- `test_field_constraint_validation` - Length and format constraint testing
- `test_uuid_validation` - UUID format validation with edge cases
- `test_timestamp_validation` - Time boundary and reasonableness validation
- `test_deduplication_logic` - Primary and secondary deduplication testing
- `test_comprehensive_validation_flow` - End-to-end validation workflow testing

### Running Tests
```bash
# Run all tests (61 total)
cargo test

# Run with performance timing
cargo test -- --nocapture

# Run specific test categories
cargo test events::types::tests          # Event system tests (55 tests)
cargo test integration_tests            # Integration tests (6 tests)
cargo test test_validation_error_messages  # Validation system tests
cargo test test_deduplication_logic     # Deduplication tests
```

### Test Performance Metrics
- **Total Tests**: 61 tests passing (100% success rate)
- **Execution Time**: All tests complete in <1.2 seconds
- **Coverage**: Comprehensive validation, serialization, and edge case testing
- **Performance**: Serialization benchmarks integrated into test suite

## Usage Examples

### Complete Development Workflow

```rust
use cc_telegram_bridge::events::types::Event;

// 1. Task started
let start_event = Event::new(
    EventType::TaskStarted,
    "claude-code",
    "task-001",
    "Implementing User Authentication",
    "Starting implementation of OAuth2 authentication system"
);

// 2. Code generated
let code_event = Event::code_generated(
    "claude-code",
    "gen-001", 
    "src/auth/oauth.rs".to_string(),
    "rust".to_string()
);

// 3. Build completed
let build_event = Event::build_completed(
    "cargo",
    "build-001",
    "debug".to_string(),
    45,   // tests passed
    0,    // tests failed  
    92.5  // coverage
);

// 4. Git commit
let commit_event = Event::git_commit(
    "git",
    "commit-001",
    "a1b2c3d4".to_string(),
    "feat: add OAuth2 authentication system".to_string(),
    "developer@example.com".to_string(),
    vec!["src/auth/oauth.rs".to_string(), "tests/auth_tests.rs".to_string()]
);

// 5. Task completion
let complete_event = Event::task_completed(
    "claude-code",
    "task-001",
    "User Authentication Complete", 
    Some("OAuth2 system implemented with 100% test coverage".to_string())
);
```

### Error Handling Workflow

```rust
// Error occurred
let error_event = Event::error_occurred(
    "compiler",
    "error-001",
    "Type Mismatch Error".to_string(),
    "Expected `String`, found `&str` at line 42".to_string(),
    "medium".to_string()
);

// Task failed
let fail_event = Event::task_failed(
    "claude-code", 
    "task-001",
    "Code Generation Failed",
    "compilation_error".to_string(),
    Some("Type mismatch in authentication module".to_string())
);
```

### Performance Monitoring

```rust
// Performance alert
let perf_event = Event::performance_alert(
    "monitoring",
    "alert-001", 
    "CPU Usage".to_string(),
    85.2, // current CPU usage
    80.0  // threshold
);

// System health check
let health_event = Event::new(
    EventType::SystemHealth,
    "health-monitor",
    "health-001",
    "System Health Check",
    "All systems operational"
);
```

## Best Practices

### Event Creation
1. **Use appropriate builder methods** for common scenarios
2. **Include relevant metadata** in the EventData structure
3. **Set appropriate severity and priority levels** for alerts
4. **Provide descriptive titles and descriptions**
5. **Use consistent source identifiers**

### Validation
1. **Always validate events** before processing
2. **Handle validation errors gracefully**
3. **Log validation failures** for debugging

### Performance
1. **Use appropriate severity levels** to avoid alert fatigue
2. **Include relevant context** in error messages
3. **Set reasonable thresholds** for performance alerts

### Testing
1. **Test event creation and validation**
2. **Verify serialization round-trips**
3. **Test error conditions and edge cases**

## Migration Guide

### From Basic Event System

If migrating from the original 3-event system:

1. **Update event type references** to use new enum variants
2. **Use builder methods** instead of manual EventData construction
3. **Add validation calls** where appropriate
4. **Update pattern matching** to handle new event types

### Example Migration

```rust
// Old code
let event = Event {
    event_type: EventType::TaskCompletion,
    // ... manual field assignment
};

// New code  
let event = Event::task_completed(
    "claude-code",
    "task-001",
    "Task Complete",
    Some("Task completed successfully".to_string())
);
```

## Troubleshooting

### Common Issues

1. **Validation Errors**: Check that required fields are present for specific event types
2. **Serialization Issues**: Ensure all custom data is JSON-serializable
3. **Pattern Match Exhaustion**: Add wildcard patterns or handle all new event types

### Debug Tips

1. **Enable detailed logging** in configuration
2. **Use event validation** to catch issues early
3. **Check event summaries** for quick debugging
4. **Verify JSON serialization** round-trips work correctly

## Future Enhancements

The event system is designed for extensibility:

1. **Additional Event Types**: Easy to add new categories and types
2. **Custom Validation Rules**: Extend validation for specific domains
3. **Enhanced Metadata**: Add domain-specific metadata fields
4. **Integration Plugins**: Support for additional notification channels

---

*This documentation covers the comprehensive event system implementation for CC Telegram Bridge v0.8.5 with enterprise-grade validation, deduplication, and serialization optimizations. The system achieves significant reliability improvements targeting zero message loss through comprehensive integrity checking and performance optimization. For the latest updates and changes, refer to the project repository.*